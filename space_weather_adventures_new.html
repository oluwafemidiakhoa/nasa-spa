<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Weather Adventures - Interactive Learning</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        .stars-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* Header */
        .header {
            position: relative;
            z-index: 10;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-bottom: 2px solid rgba(0, 255, 255, 0.3);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, #00ffff, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .nav-btn.story {
            background: linear-gradient(135deg, #ff6b9d, #c44569);
            color: white;
        }

        .nav-btn.professional {
            background: linear-gradient(135deg, #00ff88, #00cc66);
            color: #000;
        }

        .nav-btn.dashboard {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .nav-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(255, 255, 255, 0.3);
        }

        /* Main Container */
        .container {
            position: relative;
            z-index: 5;
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Live Data Section */
        .live-data-section {
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .section-title {
            font-size: 2rem;
            text-align: center;
            margin-bottom: 25px;
            background: linear-gradient(135deg, #00ffff, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .data-card {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(0, 255, 255, 0.4);
            border-radius: 15px;
            padding: 25px 15px;
            text-align: center;
            transition: all 0.3s;
            min-width: 0;
            overflow: hidden;
        }

        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 255, 0.4);
            border-color: rgba(0, 255, 255, 0.8);
        }

        .data-value {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #00ff88, #00ffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 10px 0;
            word-break: break-word;
            overflow-wrap: break-word;
            line-height: 1.1;
        }

        .data-label {
            font-size: 1.1rem;
            color: #00ffff;
            margin-top: 10px;
        }

        /* Story Character Section */
        .character-section {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .character-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .character-avatar {
            font-size: 8rem;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.6));
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .character-name {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .character-dialogue {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 30px;
            border-radius: 20px;
            font-size: 1.3rem;
            line-height: 1.8;
            text-align: center;
            max-width: 900px;
            margin: 0 auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .character-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 25px;
        }

        .char-control-btn {
            padding: 15px 35px;
            font-size: 1.1rem;
            font-weight: 700;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .char-control-btn.speak {
            background: linear-gradient(135deg, #00ff88, #00cc66);
            color: #000;
        }

        .char-control-btn.next {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .char-control-btn.switch {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #000;
        }

        .char-control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 255, 255, 0.3);
        }

        .char-control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Characters Grid */
        .characters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .character-card {
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .character-card:hover {
            transform: scale(1.05);
            border-color: rgba(255, 215, 0, 0.8);
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.4);
        }

        .character-card.active {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
        }

        .card-avatar {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .card-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .card-title {
            font-size: 1rem;
            color: #00ffff;
            font-style: italic;
        }

        /* NASA Events Section */
        .events-section {
            background: rgba(255, 107, 157, 0.1);
            border: 2px solid rgba(255, 107, 157, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .event-card {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 107, 157, 0.4);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s;
        }

        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 107, 157, 0.4);
        }

        .event-type {
            display: inline-block;
            padding: 5px 15px;
            background: linear-gradient(135deg, #ff6b9d, #c44569);
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .event-date {
            color: #00ffff;
            font-size: 0.95rem;
            margin-bottom: 10px;
        }

        .event-description {
            color: #ddd;
            font-size: 1rem;
            line-height: 1.6;
        }

        /* Voice Indicator */
        .voice-indicator {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #00ff88, #00cc66);
            color: #000;
            padding: 20px 35px;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 700;
            box-shadow: 0 10px 40px rgba(0, 255, 136, 0.6);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: pulse 1.5s infinite;
        }

        .voice-indicator.active {
            display: flex;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 10px 40px rgba(0, 255, 136, 0.6); }
            50% { box-shadow: 0 10px 60px rgba(0, 255, 136, 1); }
        }

        .wave-animation {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .wave-bar {
            width: 4px;
            background: #000;
            border-radius: 2px;
            animation: wave 0.8s infinite ease-in-out;
        }

        .wave-bar:nth-child(1) { height: 15px; animation-delay: 0s; }
        .wave-bar:nth-child(2) { height: 20px; animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { height: 25px; animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { height: 20px; animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { height: 15px; animation-delay: 0.4s; }

        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(1.5); }
        }

        /* Loading Indicator */
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.3rem;
            color: #00ffff;
        }

        .spinner {
            border: 4px solid rgba(0, 255, 255, 0.2);
            border-top: 4px solid #00ffff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .logo h1 {
                font-size: 1.5rem;
            }

            .character-avatar {
                font-size: 5rem;
            }

            .character-name {
                font-size: 2rem;
            }

            .character-dialogue {
                font-size: 1.1rem;
                padding: 20px;
            }

            .data-value {
                font-size: 2rem;
            }
        }

        @media (max-width: 1200px) {
            .data-value {
                font-size: 2.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Animated Stars Background -->
    <div class="stars-bg" id="starsBg"></div>

    <!-- Voice Indicator -->
    <div class="voice-indicator" id="voiceIndicator">
        <div class="wave-animation">
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
        </div>
        <span>Speaking...</span>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-rocket" style="font-size: 2.5rem; color: #00ffff;"></i>
                <h1>Space Weather Adventures</h1>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn story active">
                    üìö Story Mode
                </button>
                <button class="nav-btn dashboard" onclick="window.location.href='dashboard_hub.html'">
                    üè† Dashboard
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Live NASA Data Section -->
        <section class="live-data-section">
            <h2 class="section-title">üõ∞Ô∏è Live NASA Space Weather Data</h2>
            <div class="data-grid">
                <div class="data-card">
                    <i class="fas fa-fire" style="font-size: 2rem; color: #ff6b9d;"></i>
                    <div class="data-value" id="cmeCount">...</div>
                    <div class="data-label">CME Events</div>
                </div>
                <div class="data-card">
                    <i class="fas fa-bolt" style="font-size: 2rem; color: #ffd700;"></i>
                    <div class="data-value" id="flareCount">...</div>
                    <div class="data-label">Solar Flares</div>
                </div>
                <div class="data-card">
                    <i class="fas fa-chart-line" style="font-size: 2rem; color: #00ff88;"></i>
                    <div class="data-value" id="activityLevel">...</div>
                    <div class="data-label">Activity Level</div>
                </div>
                <div class="data-card">
                    <i class="fas fa-clock" style="font-size: 2rem; color: #00ffff;"></i>
                    <div class="data-value" id="lastUpdate" style="font-size: 1.5rem;">...</div>
                    <div class="data-label">Last Update</div>
                </div>
            </div>
        </section>

        <!-- Story Character Section -->
        <section class="character-section">
            <h2 class="section-title">üåü Meet Your Space Weather Friends</h2>

            <div class="character-display">
                <div class="character-avatar" id="characterAvatar">üåû</div>
                <div class="character-name" id="characterName">Sunny the Sun</div>
                <div class="character-dialogue" id="characterDialogue">
                    Hello, young space explorer! I'm Sunny, the star at the center of our solar system!
                    I create solar flares and coronal mass ejections that travel through space.
                    Click the SPEAK button to hear me tell you all about space weather!
                </div>
            </div>

            <div class="character-controls">
                <button class="char-control-btn speak" id="speakBtn" onclick="speakCurrentDialogue()">
                    <i class="fas fa-volume-up"></i> SPEAK
                </button>
                <button class="char-control-btn next" onclick="nextDialogue()">
                    <i class="fas fa-forward"></i> NEXT
                </button>
                <button class="char-control-btn switch" onclick="switchCharacter()">
                    <i class="fas fa-sync-alt"></i> SWITCH CHARACTER
                </button>
            </div>

            <!-- Character Selection -->
            <div class="characters-grid">
                <div class="character-card active" onclick="selectCharacter('sunny')">
                    <div class="card-avatar">üåû</div>
                    <div class="card-name">Sunny</div>
                    <div class="card-title">The Sun</div>
                </div>
                <div class="character-card" onclick="selectCharacter('terra')">
                    <div class="card-avatar">üåç</div>
                    <div class="card-name">Terra</div>
                    <div class="card-title">The Earth</div>
                </div>
                <div class="character-card" onclick="selectCharacter('aurora')">
                    <div class="card-avatar">‚ú®</div>
                    <div class="card-name">Aurora</div>
                    <div class="card-title">The Guardian</div>
                </div>
                <div class="character-card" onclick="selectCharacter('parker')">
                    <div class="card-avatar">üõ∞Ô∏è</div>
                    <div class="card-name">Parker</div>
                    <div class="card-title">The Probe</div>
                </div>
            </div>
        </section>

        <!-- Recent NASA Events -->
        <section class="events-section">
            <h2 class="section-title">üî• Recent Space Weather Events</h2>
            <div class="events-grid" id="eventsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading NASA data...
                </div>
            </div>
        </section>
    </div>

    <script>
        // Create animated stars
        function createStars() {
            const bg = document.getElementById('starsBg');
            for (let i = 0; i < 150; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = star.style.height = Math.random() * 3 + 1 + 'px';
                star.style.animation = `twinkle ${Math.random() * 3 + 2}s infinite`;
                star.style.animationDelay = Math.random() * 2 + 's';
                bg.appendChild(star);
            }
        }
        createStars();

        // Characters data
        const characters = {
            sunny: {
                name: "Sunny the Sun",
                avatar: "üåû",
                voiceId: "pNInz6obpgDQGcFmaJgB",
                dialogues: [
                    "Hello, young space explorer! I'm Sunny, the star at the center of our solar system! I'm a massive ball of super-hot gas, converting millions of tons of hydrogen into energy every second through nuclear fusion.",
                    "I create solar flares - powerful bursts of radiation that shoot out from my surface! These can be as powerful as billions of nuclear bombs. When I'm really active, I can send out coronal mass ejections too!",
                    "Did you know I'm about 93 million miles from Earth? That's why my light takes 8 minutes to reach you! I'm also 109 times wider than Earth - you could fit more than a million Earths inside me!",
                    "Right now, I'm monitoring " + (window.nasaData?.cmeCount || 0) + " CME events and " + (window.nasaData?.flareCount || 0) + " solar flares. My activity level is " + (window.nasaData?.activityLevel || "moderate") + ". Isn't space weather exciting?"
                ]
            },
            terra: {
                name: "Terra the Earth",
                avatar: "üåç",
                voiceId: "EXAVITQu4vr4xnSDxMaL",
                dialogues: [
                    "Hello, young explorer! I'm Terra, your home planet Earth! I have a special invisible shield called the magnetosphere that protects all life from harmful solar radiation.",
                    "When Sunny sends solar particles my way, my magnetic field deflects most of them around me! But some particles get caught near my poles, and that's when the magic happens - beautiful auroras light up the night sky!",
                    "My magnetosphere extends about 370,000 miles into space on the sun-facing side! Without this protection, solar wind would slowly strip away my atmosphere, just like what happened to Mars.",
                    "I rotate once every 24 hours giving you day and night, and I orbit around Sunny once every 365 days, creating the seasons you love. I'm the only known planet with life in the entire universe!"
                ]
            },
            aurora: {
                name: "Aurora the Guardian",
                avatar: "‚ú®",
                voiceId: "TxGEqnHWrfWFTfGW9XjX",
                dialogues: [
                    "Greetings, young scientist! I'm Aurora, the beautiful dancing lights you see near Earth's poles! I appear when charged particles from the Sun collide with gases in Earth's atmosphere.",
                    "Different gases create different colors - oxygen creates green and red lights, while nitrogen creates blue and purple! I'm strongest during solar storms when Sunny is very active.",
                    "You can see me best in places like Alaska, Canada, Iceland, Norway, Sweden, and Finland! I appear in the southern hemisphere too - there I'm called Aurora Australis, the Southern Lights!",
                    "Ancient people thought I was the spirits of their ancestors dancing in the sky. Today, scientists study me to learn about space weather and how it affects Earth. I'm nature's most spectacular light show!"
                ]
            },
            parker: {
                name: "Parker the Probe",
                avatar: "üõ∞Ô∏è",
                voiceId: "AZnzlk1XvdvUeBnXmlld",
                dialogues: [
                    "Hey there, future astronaut! I'm Parker, the Parker Solar Probe! I'm the fastest human-made object ever built, traveling at speeds up to 430,000 miles per hour!",
                    "My mission is to fly closer to the Sun than any spacecraft in history - I get within 4 million miles of Sunny's surface! I have a special heat shield that protects my instruments from temperatures over 2,500 degrees Fahrenheit.",
                    "I measure the solar wind, magnetic fields, and energy particles to help scientists predict space weather. The data I collect helps protect satellites, astronauts, and technology on Earth.",
                    "I was launched in 2018 and I'll study the Sun until 2025, completing 24 orbits! I'm named after Eugene Parker, a solar scientist who predicted the solar wind back in 1958. I'm like a weather station in space!"
                ]
            }
        };

        // Current state
        let currentCharacter = 'sunny';
        let currentDialogueIndex = 0;
        let currentAudio = null;
        let nasaData = {
            cmeCount: 0,
            flareCount: 0,
            activityLevel: 'MODERATE',
            lastUpdate: new Date().toLocaleTimeString()
        };

        // Voice system
        async function speakCurrentDialogue() {
            const char = characters[currentCharacter];
            const dialogue = char.dialogues[currentDialogueIndex];

            await speakText(dialogue, char.voiceId, char.name);
        }

        async function speakText(text, voiceId, characterName) {
            // Stop any current audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            window.speechSynthesis.cancel();

            const indicator = document.getElementById('voiceIndicator');
            const speakBtn = document.getElementById('speakBtn');

            indicator.classList.add('active');
            speakBtn.disabled = true;

            try {
                // Try ElevenLabs API
                const response = await fetch('/api/speak', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        voice_id: voiceId,
                        character: characterName
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const audioUrl = URL.createObjectURL(blob);
                    currentAudio = new Audio(audioUrl);

                    currentAudio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        indicator.classList.remove('active');
                        speakBtn.disabled = false;
                        currentAudio = null;
                    };

                    currentAudio.onerror = () => {
                        console.log('Audio playback failed, using browser TTS...');
                        useBrowserTTS(text);
                        indicator.classList.remove('active');
                        speakBtn.disabled = false;
                    };

                    await currentAudio.play();
                    console.log('üéôÔ∏è Speaking with ElevenLabs!');
                } else {
                    throw new Error('ElevenLabs API failed');
                }
            } catch (error) {
                console.log('ElevenLabs not available, using browser TTS...', error);
                useBrowserTTS(text);
                indicator.classList.remove('active');
                speakBtn.disabled = false;
            }
        }

        function useBrowserTTS(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;

            const voices = window.speechSynthesis.getVoices();
            const preferredVoice = voices.find(voice =>
                voice.name.includes('Google') ||
                voice.name.includes('Microsoft') ||
                voice.lang.startsWith('en')
            );

            if (preferredVoice) {
                utterance.voice = preferredVoice;
            }

            const indicator = document.getElementById('voiceIndicator');
            const speakBtn = document.getElementById('speakBtn');

            utterance.onend = () => {
                indicator.classList.remove('active');
                speakBtn.disabled = false;
            };

            window.speechSynthesis.speak(utterance);
            console.log('üîä Speaking with browser TTS');
        }

        // Character controls
        function nextDialogue() {
            const char = characters[currentCharacter];
            currentDialogueIndex = (currentDialogueIndex + 1) % char.dialogues.length;
            updateCharacterDisplay();
        }

        function switchCharacter() {
            const charKeys = Object.keys(characters);
            const currentIndex = charKeys.indexOf(currentCharacter);
            const nextIndex = (currentIndex + 1) % charKeys.length;
            selectCharacter(charKeys[nextIndex]);
        }

        function selectCharacter(charKey) {
            currentCharacter = charKey;
            currentDialogueIndex = 0;

            // Update active state
            document.querySelectorAll('.character-card').forEach(card => {
                card.classList.remove('active');
            });
            event?.target?.closest('.character-card')?.classList.add('active');

            updateCharacterDisplay();
        }

        function updateCharacterDisplay() {
            const char = characters[currentCharacter];
            const dialogue = char.dialogues[currentDialogueIndex];

            document.getElementById('characterAvatar').textContent = char.avatar;
            document.getElementById('characterName').textContent = char.name;
            document.getElementById('characterDialogue').textContent = dialogue;

            // Update active card if not clicked
            if (!event || !event.target.closest('.character-card')) {
                document.querySelectorAll('.character-card').forEach((card, idx) => {
                    const charKeys = Object.keys(characters);
                    card.classList.toggle('active', charKeys[idx] === currentCharacter);
                });
            }
        }

        // NASA Data Loading
        async function loadNASAData() {
            try {
                const endDate = new Date();
                const startDate = new Date(endDate.getTime() - 7 * 24 * 60 * 60 * 1000);

                const formatDate = (date) => date.toISOString().split('T')[0];

                // Fetch CMEs
                const cmeResponse = await fetch(
                    `https://api.nasa.gov/DONKI/CME?startDate=${formatDate(startDate)}&endDate=${formatDate(endDate)}&api_key=DEMO_KEY`
                );
                const cmeData = await cmeResponse.json();

                // Fetch Solar Flares
                const flareResponse = await fetch(
                    `https://api.nasa.gov/DONKI/FLR?startDate=${formatDate(startDate)}&endDate=${formatDate(endDate)}&api_key=DEMO_KEY`
                );
                const flareData = await flareResponse.json();

                nasaData.cmeCount = cmeData.length || 0;
                nasaData.flareCount = flareData.length || 0;
                nasaData.lastUpdate = new Date().toLocaleTimeString();

                // Determine activity level
                const totalEvents = nasaData.cmeCount + nasaData.flareCount;
                if (totalEvents > 20) nasaData.activityLevel = 'HIGH';
                else if (totalEvents > 10) nasaData.activityLevel = 'MODERATE';
                else nasaData.activityLevel = 'LOW';

                // Update display
                document.getElementById('cmeCount').textContent = nasaData.cmeCount;
                document.getElementById('flareCount').textContent = nasaData.flareCount;
                document.getElementById('activityLevel').textContent = nasaData.activityLevel;
                document.getElementById('lastUpdate').textContent = nasaData.lastUpdate;

                // Display events
                displayEvents(cmeData, flareData);

                console.log('‚úÖ NASA data loaded successfully!');
            } catch (error) {
                console.error('Error loading NASA data:', error);
                // Show sample data
                nasaData = { cmeCount: 10, flareCount: 4, activityLevel: 'MODERATE', lastUpdate: new Date().toLocaleTimeString() };
                document.getElementById('cmeCount').textContent = nasaData.cmeCount;
                document.getElementById('flareCount').textContent = nasaData.flareCount;
                document.getElementById('activityLevel').textContent = nasaData.activityLevel;
                document.getElementById('lastUpdate').textContent = nasaData.lastUpdate;
            }
        }

        function displayEvents(cmeData, flareData) {
            const eventsGrid = document.getElementById('eventsGrid');
            eventsGrid.innerHTML = '';

            const allEvents = [];

            // Add CME events
            (cmeData || []).slice(0, 3).forEach(cme => {
                allEvents.push({
                    type: 'CME',
                    date: new Date(cme.startTime).toLocaleDateString(),
                    description: `Coronal Mass Ejection detected. Speed: ${cme.cmeAnalyses?.[0]?.speed || 'Unknown'} km/s`
                });
            });

            // Add Flare events
            (flareData || []).slice(0, 3).forEach(flare => {
                allEvents.push({
                    type: 'Solar Flare',
                    date: new Date(flare.beginTime).toLocaleDateString(),
                    description: `${flare.classType || 'Unknown'} class solar flare detected at ${flare.sourceLocation || 'Unknown location'}`
                });
            });

            if (allEvents.length === 0) {
                eventsGrid.innerHTML = '<div class="loading">No recent events detected. Space weather is quiet!</div>';
                return;
            }

            allEvents.forEach(event => {
                const card = document.createElement('div');
                card.className = 'event-card';
                card.innerHTML = `
                    <div class="event-type">${event.type}</div>
                    <div class="event-date">üìÖ ${event.date}</div>
                    <div class="event-description">${event.description}</div>
                `;
                eventsGrid.appendChild(card);
            });
        }

        // Load voices for browser TTS
        if (window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = () => {
                window.speechSynthesis.getVoices();
            };
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            loadNASAData();
            updateCharacterDisplay();
            console.log('üöÄ Space Weather Adventures loaded!');
        });

        // Refresh data every 5 minutes
        setInterval(loadNASAData, 5 * 60 * 1000);
    </script>
</body>
</html>
