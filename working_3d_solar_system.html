<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåü NASA 3D Space Weather - WORKING VERSION</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="live_nasa_data.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #000011, #001122);
            color: #fff;
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }

        #canvas-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #info-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 20px;
            min-width: 300px;
            z-index: 1000;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 1rem;
        }

        .status-label {
            color: #00ffff;
        }

        .status-value {
            color: #00ff00;
            font-weight: bold;
        }

        #data-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ff8000;
            border-radius: 10px;
            padding: 20px;
            max-width: 350px;
            max-height: 70vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .event-card {
            background: rgba(255, 128, 0, 0.1);
            border: 1px solid #ff8000;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .event-card:hover {
            background: rgba(255, 128, 0, 0.2);
        }

        .loading {
            text-align: center;
            color: #00ffff;
            font-size: 1.2rem;
            margin: 20px 0;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ffff00;
            border-radius: 10px;
            padding: 15px;
            z-index: 1000;
        }

        .control-btn {
            background: #00bfff;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
        }

        .control-btn:hover {
            background: #00ffff;
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    
    <div id="info-overlay">
        <h2 style="color: #00ffff; margin-bottom: 15px;">üõ∞Ô∏è MISSION STATUS</h2>
        <div class="status-item">
            <span class="status-label">CME Events:</span>
            <span class="status-value" id="cme-count">Loading...</span>
        </div>
        <div class="status-item">
            <span class="status-label">Solar Flares:</span>
            <span class="status-value" id="flare-count">Loading...</span>
        </div>
        <div class="status-item">
            <span class="status-label">Activity Level:</span>
            <span class="status-value" id="activity-level">Loading...</span>
        </div>
        <div class="status-item">
            <span class="status-label">Data Status:</span>
            <span class="status-value" id="data-status">üü° CONNECTING</span>
        </div>
        <div class="status-item">
            <span class="status-label">3D Objects:</span>
            <span class="status-value" id="object-count">0</span>
        </div>
    </div>

    <div id="data-panel">
        <h3 style="color: #ff8000; margin-bottom: 15px;">üìä LIVE NASA EVENTS</h3>
        <div id="events-container">
            <div class="loading">üåÄ Loading NASA data...</div>
        </div>
    </div>

    <div class="controls">
        <h4 style="color: #ffff00; margin-bottom: 10px;">üéÆ CONTROLS</h4>
        <button class="control-btn" onclick="resetCamera()">üîÑ Reset View</button>
        <button class="control-btn" onclick="toggleAnimation()">‚èØÔ∏è Play/Pause</button>
        <button class="control-btn" onclick="addRandomCME()">üåÄ Add CME</button>
    </div>

    <script>
        let scene, camera, renderer;
        let sun, earth, moon;
        let cmeParticles = [];
        let animationRunning = true;
        let mouseX = 0, mouseY = 0;
        let cameraAngle = 0;

        console.log('üöÄ Starting Working 3D Solar System...');

        function init() {
            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000011);

            // Create camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 30, 80);

            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Create stars
            createStars();

            // Create solar system
            createSolarSystem();

            // Add lighting
            addLighting();

            // Setup mouse controls
            setupControls();

            // Load NASA data
            setTimeout(loadNASAData, 1000);

            // Start animation
            animate();

            console.log('‚úÖ 3D Solar System created successfully!');
            updateObjectCount();
        }

        function createStars() {
            const starGeometry = new THREE.BufferGeometry();
            const starCount = 5000;
            const positions = new Float32Array(starCount * 3);

            for (let i = 0; i < starCount * 3; i++) {
                positions[i] = (Math.random() - 0.5) * 1000;
            }

            starGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            const starMaterial = new THREE.PointsMaterial({ 
                color: 0xffffff, 
                size: 1
            });

            const stars = new THREE.Points(starGeometry, starMaterial);
            scene.add(stars);
            console.log('‚≠ê Stars created');
        }

        function createSolarSystem() {
            // Create Sun
            const sunGeometry = new THREE.SphereGeometry(8, 32, 32);
            const sunMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xffff00,
                emissive: 0xff8800
            });
            sun = new THREE.Mesh(sunGeometry, sunMaterial);
            scene.add(sun);

            // Create Earth
            const earthGeometry = new THREE.SphereGeometry(3, 32, 32);
            const earthMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x0066cc
            });
            earth = new THREE.Mesh(earthGeometry, earthMaterial);
            earth.position.set(50, 0, 0);
            scene.add(earth);

            // Create Moon
            const moonGeometry = new THREE.SphereGeometry(1, 16, 16);
            const moonMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xcccccc
            });
            moon = new THREE.Mesh(moonGeometry, moonMaterial);
            moon.position.set(56, 0, 0);
            scene.add(moon);

            console.log('üåç Solar system objects created');
        }

        function addLighting() {
            // Ambient light
            const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
            scene.add(ambientLight);

            // Point light from sun
            const pointLight = new THREE.PointLight(0xffffff, 1, 300);
            pointLight.position.set(0, 0, 0);
            scene.add(pointLight);

            console.log('üí° Lighting added');
        }

        function setupControls() {
            let isMouseDown = false;

            renderer.domElement.addEventListener('mousedown', () => isMouseDown = true);
            renderer.domElement.addEventListener('mouseup', () => isMouseDown = false);
            
            renderer.domElement.addEventListener('mousemove', (event) => {
                if (isMouseDown) {
                    mouseX = (event.clientX / window.innerWidth) * 2 - 1;
                    mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
                    
                    cameraAngle += mouseX * 0.05;
                    camera.position.x = Math.cos(cameraAngle) * 80;
                    camera.position.z = Math.sin(cameraAngle) * 80;
                    camera.lookAt(0, 0, 0);
                }
            });

            renderer.domElement.addEventListener('wheel', (event) => {
                const scale = event.deltaY > 0 ? 1.1 : 0.9;
                camera.position.multiplyScalar(scale);
                camera.position.clampLength(20, 200);
            });

            console.log('üéÆ Controls setup');
        }

        function loadNASAData() {
            console.log('üì° Attempting to load NASA data...');
            
            if (window.LIVE_NASA_DATA && window.LIVE_NASA_DATA.events) {
                const data = window.LIVE_NASA_DATA;
                console.log('‚úÖ NASA data loaded:', data);

                // Update status display
                document.getElementById('cme-count').textContent = data.summary.cme_count || 0;
                document.getElementById('flare-count').textContent = data.summary.solar_flare_count || 0;
                
                const totalEvents = data.summary.total_events || 0;
                let activity = 'QUIET';
                if (totalEvents > 30) activity = 'EXTREME';
                else if (totalEvents > 20) activity = 'HIGH';
                else if (totalEvents > 10) activity = 'MODERATE';
                else if (totalEvents > 5) activity = 'LOW';
                
                document.getElementById('activity-level').textContent = activity;
                document.getElementById('data-status').textContent = 'üü¢ LIVE NASA';

                // Create CME visualizations
                createCMEVisualizations(data.events.cmes);
                
                // Update events panel
                updateEventsPanel(data.events);
                
            } else {
                console.log('‚ùå NASA data not available, using fallback...');
                document.getElementById('data-status').textContent = 'üü† DEMO MODE';
                createDemoVisualization();
                setTimeout(loadNASAData, 3000);
            }
        }

        function createCMEVisualizations(cmes) {
            if (!cmes || cmes.length === 0) return;

            cmes.slice(0, 8).forEach((cme, index) => {
                const speed = cme.speed || 500;
                
                // Create CME particle system
                const particleCount = 100;
                const particles = new THREE.BufferGeometry();
                const positions = new Float32Array(particleCount * 3);
                const colors = new Float32Array(particleCount * 3);

                for (let i = 0; i < particleCount; i++) {
                    const i3 = i * 3;
                    const angle = (index / 8) * Math.PI * 2 + (Math.random() - 0.5) * 0.5;
                    const distance = 12 + Math.random() * 20;
                    
                    positions[i3] = Math.cos(angle) * distance;
                    positions[i3 + 1] = (Math.random() - 0.5) * 8;
                    positions[i3 + 2] = Math.sin(angle) * distance;

                    // Color based on speed
                    const intensity = Math.min(speed / 1000, 1);
                    colors[i3] = 1;
                    colors[i3 + 1] = 1 - intensity * 0.8;
                    colors[i3 + 2] = 0;
                }

                particles.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                particles.setAttribute('color', new THREE.BufferAttribute(colors, 3));

                const material = new THREE.PointsMaterial({
                    size: 2,
                    transparent: true,
                    opacity: 0.8,
                    vertexColors: true,
                    blending: THREE.AdditiveBlending
                });

                const cmeSystem = new THREE.Points(particles, material);
                cmeSystem.userData = { 
                    type: 'cme', 
                    speed: speed,
                    startTime: Date.now(),
                    angle: angle
                };
                
                scene.add(cmeSystem);
                cmeParticles.push(cmeSystem);
            });

            console.log(`üåÄ Created ${cmeParticles.length} CME visualizations`);
            updateObjectCount();
        }

        function createDemoVisualization() {
            // Create a few demo CME particles
            for (let i = 0; i < 3; i++) {
                const particleCount = 50;
                const particles = new THREE.BufferGeometry();
                const positions = new Float32Array(particleCount * 3);

                for (let j = 0; j < particleCount; j++) {
                    const j3 = j * 3;
                    const angle = (i / 3) * Math.PI * 2;
                    const distance = 15 + Math.random() * 15;
                    
                    positions[j3] = Math.cos(angle) * distance;
                    positions[j3 + 1] = (Math.random() - 0.5) * 6;
                    positions[j3 + 2] = Math.sin(angle) * distance;
                }

                particles.setAttribute('position', new THREE.BufferAttribute(positions, 3));

                const material = new THREE.PointsMaterial({
                    color: 0xff8000,
                    size: 1.5,
                    transparent: true,
                    opacity: 0.7
                });

                const demoSystem = new THREE.Points(particles, material);
                demoSystem.userData = { 
                    type: 'demo',
                    startTime: Date.now(),
                    angle: (i / 3) * Math.PI * 2
                };
                
                scene.add(demoSystem);
                cmeParticles.push(demoSystem);
            }
            
            document.getElementById('cme-count').textContent = '3 (Demo)';
            document.getElementById('activity-level').textContent = 'DEMO';
            updateObjectCount();
        }

        function updateEventsPanel(events) {
            const container = document.getElementById('events-container');
            container.innerHTML = '';

            // Add CME events
            events.cmes.slice(0, 5).forEach(cme => {
                const card = document.createElement('div');
                card.className = 'event-card';
                card.innerHTML = `
                    <strong>üåÄ CME ${cme.id.slice(-6)}</strong><br>
                    Speed: ${cme.speed || 'Unknown'} km/s<br>
                    <small>${new Date(cme.start_time).toLocaleString()}</small>
                `;
                container.appendChild(card);
            });

            // Add solar flare events
            events.solar_flares.slice(0, 3).forEach(flare => {
                const card = document.createElement('div');
                card.className = 'event-card';
                card.style.borderColor = '#ff0000';
                card.innerHTML = `
                    <strong>‚òÄÔ∏è ${flare.class_type || 'C1.0'} Flare</strong><br>
                    <small>${new Date(flare.start_time).toLocaleString()}</small>
                `;
                container.appendChild(card);
            });
        }

        function updateObjectCount() {
            const count = scene.children.length;
            document.getElementById('object-count').textContent = count;
        }

        function animate() {
            requestAnimationFrame(animate);

            if (animationRunning) {
                const time = Date.now() * 0.001;

                // Rotate sun
                if (sun) {
                    sun.rotation.y += 0.02;
                }

                // Orbit earth
                if (earth) {
                    earth.position.x = Math.cos(time * 0.2) * 50;
                    earth.position.z = Math.sin(time * 0.2) * 50;
                    earth.rotation.y += 0.03;
                }

                // Orbit moon around earth
                if (moon) {
                    moon.position.x = earth.position.x + Math.cos(time * 0.8) * 6;
                    moon.position.z = earth.position.z + Math.sin(time * 0.8) * 6;
                }

                // Animate CME particles
                cmeParticles.forEach(cme => {
                    const elapsed = (Date.now() - cme.userData.startTime) / 1000;
                    const positions = cme.geometry.attributes.position.array;
                    
                    for (let i = 0; i < positions.length; i += 3) {
                        // Move particles outward
                        const speed = cme.userData.speed ? cme.userData.speed / 10000 : 0.01;
                        positions[i] *= (1 + speed);
                        positions[i + 2] *= (1 + speed);
                    }
                    
                    cme.geometry.attributes.position.needsUpdate = true;
                    
                    // Fade out over time
                    if (elapsed > 30) {
                        cme.material.opacity = Math.max(0, 1 - (elapsed - 30) / 10);
                    }
                });
            }

            renderer.render(scene, camera);
        }

        function resetCamera() {
            camera.position.set(0, 30, 80);
            camera.lookAt(0, 0, 0);
            cameraAngle = 0;
        }

        function toggleAnimation() {
            animationRunning = !animationRunning;
            console.log('Animation:', animationRunning ? 'Playing' : 'Paused');
        }

        function addRandomCME() {
            const particleCount = 80;
            const particles = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);

            const angle = Math.random() * Math.PI * 2;
            
            for (let i = 0; i < particleCount; i++) {
                const i3 = i * 3;
                const distance = 12 + Math.random() * 15;
                
                positions[i3] = Math.cos(angle) * distance;
                positions[i3 + 1] = (Math.random() - 0.5) * 6;
                positions[i3 + 2] = Math.sin(angle) * distance;
            }

            particles.setAttribute('position', new THREE.BufferAttribute(positions, 3));

            const material = new THREE.PointsMaterial({
                color: Math.random() > 0.5 ? 0xff8000 : 0xff0000,
                size: 2,
                transparent: true,
                opacity: 0.9,
                blending: THREE.AdditiveBlending
            });

            const newCME = new THREE.Points(particles, material);
            newCME.userData = { 
                type: 'manual',
                speed: 500 + Math.random() * 500,
                startTime: Date.now(),
                angle: angle
            };
            
            scene.add(newCME);
            cmeParticles.push(newCME);
            updateObjectCount();
            
            console.log('üåÄ Manual CME added');
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        window.addEventListener('resize', onWindowResize);

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Initializing Working 3D Solar System...');
            init();
        });

        // WebSocket handler for real-time updates
        window.updateWorkingSolarSystemWithLiveData = function(data) {
            console.log('üì° Receiving real-time data update:', data);
            if (data.events && data.events.cmes) {
                // Clear old CMEs and create new ones
                cmeParticles.forEach(cme => scene.remove(cme));
                cmeParticles = [];
                createCMEVisualizations(data.events.cmes);
            }
        };
    </script>
</body>
</html>